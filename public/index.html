<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Sherin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #4158d0, #c850c0, #ffcc70);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    .wrap-table100 {
      background: #fff;
      width: 100%;
      max-width: 95%;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
      overflow-x: auto;
      margin-top: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead {
      background: #111;
      color: #fff;
    }
    th, td {
      border: 1px solid #eee;
      padding: 10px 15px;
      text-align: left;
    }
    td[contenteditable="true"] {
      background: #f9f9ff;
    }
    tr:nth-child(even) td { background: #fafafa; }
    button {
      padding: 6px 12px;
      background: #4158d0;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: 0.2s;
    }
    button:hover {
      background: #2e3ba8;
    }
    .btn-delete {
      width: 100%;
      background: #e74c3c;
    }
    .btn-delete:hover {
      background: #c0392b;
    }
    .btn-save {
      width: 100%;
      background: #27ae60;
      display: none;
    }
    .btn-save:hover {
      background: #1e8449;
    }
    .row-inserter td {
      text-align: center;
      padding: 4px;
      border: none;
    }
    .btn-insert {
      display: none;
      background: #3498db;
      border-radius: 50%;
      padding: 4px 8px;
      font-size: 16px;
    }
    .row-inserter:hover .btn-insert {
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="wrap-table100">
    <table id="excel-table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let tableData = [];

    // –ó–∞–≥—Ä—É–∂–∞–µ–º Excel
    async function loadExcel() {
      try {
        let response = await fetch("data.xlsx"); // –∏—â–µ–º —Ä—è–¥–æ–º —Å index.html
        let arrayBuffer = await response.arrayBuffer();

        let workbook = XLSX.read(arrayBuffer, { type: "array" });
        let sheetName = workbook.SheetNames[0];
        let worksheet = workbook.Sheets[sheetName];
        tableData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

        renderTable(tableData);
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Excel:", err);
      }
    }

    // –†–∏—Å—É–µ–º —Ç–∞–±–ª–∏—Ü—É
    function renderTable(data) {
      let thead = document.querySelector("#excel-table thead");
      let tbody = document.querySelector("#excel-table tbody");
      thead.innerHTML = "";
      tbody.innerHTML = "";

      if (data.length > 0) {
        let headerRow = document.createElement("tr");
        data[0].forEach(col => {
          let th = document.createElement("th");
          th.textContent = col;
          headerRow.appendChild(th);
        });

        let thDelete = document.createElement("th");
        thDelete.textContent = "–£–¥–∞–ª–∏—Ç—å";
        headerRow.appendChild(thDelete);

        let thSave = document.createElement("th");
        thSave.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
        headerRow.appendChild(thSave);

        thead.appendChild(headerRow);
      }

      for (let i = 1; i < data.length; i++) {
        let row = createRow(data[i]);
        tbody.appendChild(row);
      }

      // –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –Ω–æ–≤–æ–π
      tbody.appendChild(createInserterRow());
    }

    // –°–æ–∑–¥–∞—ë–º —Å—Ç—Ä–æ–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
    function createRow(rowData = []) {
      let row = document.createElement("tr");

      rowData.forEach(cell => {
        let td = document.createElement("td");
        td.contentEditable = "true";
        td.textContent = cell;
        td.addEventListener("input", () => {
          row.querySelector(".btn-save").style.display = "inline-block";
        });
        row.appendChild(td);
      });

      // —É–¥–∞–ª–∏—Ç—å
      let tdDelete = document.createElement("td");
      let btnDelete = document.createElement("button");
      btnDelete.textContent = "üóë";
      btnDelete.className = "btn-delete";
      btnDelete.onclick = () => row.remove();
      tdDelete.appendChild(btnDelete);
      row.appendChild(tdDelete);

      // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
      let tdSave = document.createElement("td");
      let btnSave = document.createElement("button");
      btnSave.textContent = "üíæ";
      btnSave.className = "btn-save";
      btnSave.onclick = () => saveAll();
      tdSave.appendChild(btnSave);
      row.appendChild(tdSave);

      return row;
    }

    // –°—Ç—Ä–æ–∫–∞-–≤—Å—Ç–∞–≤–∫–∞
    function createInserterRow() {
      let inserterRow = document.createElement("tr");
      inserterRow.className = "row-inserter";

      let td = document.createElement("td");
      td.colSpan = document.querySelectorAll("#excel-table thead th").length;
      let btn = document.createElement("button");
      btn.textContent = "‚ûï";
      btn.className = "btn-insert";
      btn.onclick = () => {
        let newRow = createRow(new Array(td.colSpan - 2).fill(""));
        inserterRow.parentNode.insertBefore(newRow, inserterRow);
      };

      td.appendChild(btn);
      inserterRow.appendChild(td);
      return inserterRow;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Excel
    async function saveAll() {
      let rows = [];
      let table = document.querySelector("#excel-table");

      let headers = [];
      table.querySelectorAll("thead th").forEach(th => {
        if (th.textContent !== "–£–¥–∞–ª–∏—Ç—å" && th.textContent !== "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å") {
          headers.push(th.textContent);
        }
      });
      rows.push(headers);

      table.querySelectorAll("tbody tr").forEach(tr => {
        if (tr.classList.contains("row-inserter")) return;
        let row = [];
        for (let i = 0; i < tr.cells.length - 2; i++) {
          row.push(tr.cells[i].textContent);
        }
        rows.push(row);
      });

      try {
        let response = await fetch("/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(rows)
        });

        if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");

        alert("‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
        document.querySelectorAll(".btn-save").forEach(btn => {
          btn.style.display = "none";
        });
      } catch (err) {
        console.error(err);
        alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏!");
      }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadExcel();
  </script>
</body>
</html>
